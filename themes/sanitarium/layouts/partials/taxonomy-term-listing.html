{{/* 
  Reusable partial for taxonomy term listing pages
  
  Expected context: 
  - .Page: the current page context
  - .Title: custom title for the header
  - .Description: custom description
  - .Stats: custom stats text  
  - .TaxonomyName: name of taxonomy for navigation
  - .AllLinkText: text for "all items" center link
  - .AllLinkURL: URL for "all items" link
*/}}

<header>
    <h1>{{ .Title }}</h1>
    {{ with .Description }}
    <div class="description">{{ . }}</div>
    {{ end }}
</header>

{{ if .Content }}
<div class="content">
    {{ .Content }}
</div>
{{ end }}

<div class="article-list">
    {{ if .Stats }}
    <div class="taxonomy-stats">
        <p>{{ .Stats }}</p>
    </div>
    {{ end }}
    
    {{/* Sort posts in ascending order (earliest first) */}}
    {{ $posts := .Page.Pages.ByDate }}
    
    {{ range $posts }}
        {{ partial "summary.html" . }}
    {{ end }}

    {{/* Prefetch first 3 posts for performance */}}
    {{ range first 3 $posts }}
        <link rel="prefetch" href="{{ .Permalink }}">
    {{ end }}
</div>

{{/* Navigation between taxonomy terms */}}
{{ if and .TaxonomyName .Page.Data.Term }}
{{ $currentTerm := .Page.Data.Term }}
{{ $allTerms := index .Page.Site.Taxonomies .TaxonomyName }}
{{ $sortedTerms := sort $allTerms.ByCount "Name" }}

{{ $currentIndex := -1 }}
{{ range $index, $term := $sortedTerms }}
    {{ if eq $term.Name $currentTerm }}
        {{ $currentIndex = $index }}
    {{ end }}
{{ end }}

{{ if ge $currentIndex 0 }}
<nav class="taxonomy-navigation">
    <div class="taxonomy-navigation-links">
        {{ if gt $currentIndex 0 }}
            {{ $prevTerm := index $sortedTerms (sub $currentIndex 1) }}
            {{ $prevName := $prevTerm.Name }}
            {{ if eq .TaxonomyName "daily" }}
                {{ $prevName = $prevName | time.Format "January 2, 2006" }}
            {{ end }}
            <a href="{{ $prevTerm.Page.Permalink }}" class="prev">← {{ $prevName }}</a>
        {{ end }}
        
        {{ if .AllLinkURL }}
        <a href="{{ .AllLinkURL }}" class="taxonomy-index">{{ .AllLinkText }}</a>
        {{ end }}
        
        {{ if lt $currentIndex (sub (len $sortedTerms) 1) }}
            {{ $nextTerm := index $sortedTerms (add $currentIndex 1) }}
            {{ $nextName := $nextTerm.Name }}
            {{ if eq .TaxonomyName "daily" }}
                {{ $nextName = $nextName | time.Format "January 2, 2006" }}
            {{ end }}
            <a href="{{ $nextTerm.Page.Permalink }}" class="next">{{ $nextName }} →</a>
        {{ end }}
    </div>
</nav>
{{ end }}
{{ end }}